Cloud=require("ti.cloud"),exports.Logout=function(){Cloud.Users.logout(function(){}),Titanium.App.Properties.removeProperty("userinfo"),Titanium.App.fireEvent("DID_LOGOUT")},exports.ConvertToMerchant=function(e,l){Cloud.Users.update({role:"merchant",su_id:e},function(e){return e.success?void l():Alloy.Globals.showError("Failed to make user merchant")})},exports.MerchantRequests=function(e){Cloud.Objects.query({classname:"MerchantRequest",page:1,per_page:100},function(l){e(l.MerchantRequest)})},exports.AskToBecomeMerchant=function(e){Cloud.Objects.create({classname:"MerchantRequest",fields:{userId:UTL.userInfo().uid}},function(l){return l.success?void e():void(errorCallback&&errorCallback({message:l.error&&l.message}))})},exports.Signup=function(e,l,o,t){Cloud.Users.create({username:e,password:l,password_confirmation:l,role:"user"},function(r){r.success?o(e,l):t(r)})},exports.Login=function(e,l){console.log("Logging in..."),Cloud.Users.login({login:e,password:l},function(o){if(o.success){var t=o.users[0];Titanium.App.Properties.setObject("userinfo",{username:e,password:l,uid:t.id,sessionid:t.is,role:t.role,admin:"true"==t.admin,photo:t.photo}),Titanium.App.fireEvent("DID_LOGIN"),exports.GetAllFriends(UTL.EmptyFn),exports.GetCouponsByLocation({},UTL.EmptyFn)}else Titanium.App.fireEvent("LOGIN_ERROR",{message:Alloy.Globals.ErrorMessages.logInIncorrect}),console.log(Alloy.Globals.ErrorMessages.logInIncorrect)})},exports.GetFriendRequests=function(e,l){Cloud.Friends.requests(function(o){return o.success?void e(o.friend_requests):void(l&&l({message:o.error&&o.message}))})},exports.NewLocation=function(e,l,o){Cloud.Places.create(e,function(e){return e.success?void l(e.places):void(o&&o({message:e.error&&e.message}))})},exports.GetMerchantLocations=function(e){Cloud.Places.query({limit:100},function(l){return l.success?void e(l.places):void(errorCallback&&errorCallback({message:l.error&&l.message}))})},exports.GetWalletItems=function(e,l){Cloud.Objects.query({classname:"WalletItem",page:1,per_page:100,where:{receiver:e}},function(e){l(e.WalletItem)})},exports.GetPhotopons=function(e,l){Cloud.Objects.query({classname:"Photopon",page:1,per_page:100,where:{id:{$in:e}}},function(e){l(e.Photopon||[])})},exports.GetCoupons=function(e,l){Cloud.Objects.query({classname:"Coupon",page:1,per_page:100,where:{id:{$in:e}}},function(e){l(e.Coupon)})},exports.NewWalletItem=function(e,l,o){Cloud.Objects.create({classname:"WalletItem",fields:{photopon:e,receiver:l}},function(e){return e.success?void o(e.WalletItem):void(errorCallback&&errorCallback({message:e.error&&e.message}))})},exports.NewCoupon=function(e,l,o){Cloud.Objects.create({classname:"Coupon",fields:e},function(e){return e.success?void l(e.Coupons):void(o&&o({message:e.error&&e.message}))})},exports.DeleteCoupon=function(e,l){Cloud.Objects.remove({classname:"Coupon",id:e},function(e){return e.success?void l():void(errorCallback&&errorCallback({message:e.error&&e.message}))})},exports.EditCoupon=function(e,l,o,t){Cloud.Objects.update({classname:"Coupon",id:e,fields:l},function(e){return e.success?void o(e.places):void(t&&t({message:e.error&&e.message}))})},exports.GetMerchantCoupons=function(e){Cloud.Objects.query({classname:"Coupon",page:1,per_page:100},function(l){e(l.Coupon)})},exports.GetCouponsByLocation=function(e,l){return Alloy.Globals.CachedCoupons?void l(Alloy.Globals.CachedCoupons):void Cloud.Objects.query({classname:"Coupon",page:1,per_page:100},function(e){l(e.Coupon),Alloy.Globals.CachedCoupons=e.Coupon})},exports.GetAllFriends=function(e,l){return Alloy.Globals.CachedFriends?void e(Alloy.Globals.CachedFriends):void Cloud.sendRequest({url:"friends/query.json",method:"GET"},function(o){return o.success?(Alloy.Globals.CachedFriends=o.users||{},void e(o.users||{})):void(l&&l({message:o.error&&o.message}))})},exports.AddFriend=function(e,l,o){Cloud.Friends.add({user_ids:e},function(e){return e.success?void l():void(o&&o({message:e.error&&e.message}))})},exports.SearchUser=function(e,l,o){Cloud.Users.search({q:e},function(t){return t.success?void l(t.users,e):void(o&&o({message:t.error&&t.message}))})},exports.GetWalletItemsSim=function(e){e([{name:"McDonalds 3 for 2 Deal",img:"http://lorempixel.com/output/food-q-c-480-480-5.jpg"},{name:"1 FREE Topping",img:"http://lorempixel.com/output/food-q-c-480-480-6.jpg"}])},exports.GetSimpleFriends=function(e,l){l([{name:"Joe Black",img:"http://lorempixel.com/output/people-q-c-480-480-5.jpg"},{name:"Jimmy Joe",img:"http://lorempixel.com/output/people-q-c-480-480-6.jpg"}])},exports.UploadPhoto=function(e,l,o){Cloud.Photos.create({photo:e},function(e){if(e.success){var t=e.photos[0];l&&l(t)}else o&&o(e)})},exports.NewPhotopon=function(e,l,o,t,r,i){Cloud.Objects.create({classname:"Photopon",fields:{coupon_id:e.id,cam_photo_id:l,overlay_photo_id:o,message:t}},function(e){return e.success?void r(e.Photopon[0]):void(i&&i({message:e.error&&e.message}))})},exports.UpdateProfilePhoto=function(e,l){Cloud.Users.update({photo_id:e},function(e){e.success?l&&l(e.users[0]):alert("Error:\n"+(e.error&&e.message||JSON.stringify(e)))})},exports.ChangePassword=function(e,l){Cloud.Users.update({password:e,password_confirmation:e},function(e){e.success?l&&l(e.users[0]):alert("Error:\n"+(e.error&&e.message||JSON.stringify(e)))})},exports.NewNotification=function(e,l,o){Cloud.Chats.create({to_ids:e,message:msg,custom_fields:{type:o}},function(e){return e.success?void 0:void alert("Failed to send message")})},exports.NewMessage=function(e,l,o,t){Cloud.Messages.create({to_ids:e.join(","),body:o,subject:l},function(e){e.success?t&&t(e.message):alert("Failed to create message")})};