(function(){var e,t=this,o=t.Backbone,l=Array.prototype.slice,i=Array.prototype.splice;e="undefined"!=typeof exports?exports:t.Backbone={},e.VERSION="0.9.2";var r=t._;r||"undefined"==typeof require||(r=require("alloy/underscore"));var n=t.jQuery||t.Zepto||t.ender;e.setDomLibrary=function(e){n=e},e.noConflict=function(){return t.Backbone=o,this},e.emulateHTTP=!1,e.emulateJSON=!1;var s=/\s+/,a=e.Events={on:function(e,t,o){var l,i,r,n,a;if(!t)return this;for(e=e.split(s),l=this._callbacks||(this._callbacks={});i=e.shift();)a=l[i],r=a?a.tail:{},r.next=n={},r.context=o,r.callback=t,l[i]={tail:n,next:a?a.next:r};return this},off:function(e,t,o){var l,i,n,a,h,u;if(i=this._callbacks){if(!(e||t||o))return delete this._callbacks,this;for(e=e?e.split(s):r.keys(i);l=e.shift();)if(n=i[l],delete i[l],n&&(t||o))for(a=n.tail;(n=n.next)!==a;)h=n.callback,u=n.context,(t&&h!==t||o&&u!==o)&&this.on(l,h,u);return this}},trigger:function(e){var t,o,i,r,n,a,h;if(!(i=this._callbacks))return this;for(a=i.all,e=e.split(s),h=l.call(arguments,1);t=e.shift();){if(o=i[t])for(r=o.tail;(o=o.next)!==r;)o.callback.apply(o.context||this,h);if(o=a)for(r=o.tail,n=[t].concat(h);(o=o.next)!==r;)o.callback.apply(o.context||this,n)}return this}};a.bind=a.on,a.unbind=a.off;var h=e.Model=function(e,t){var o;e||(e={}),t&&t.parse&&(e=this.parse(e)),(o=k(this,"defaults"))&&(e=r.extend({},o,e)),t&&t.collection&&(this.collection=t.collection),this.attributes={},this._escapedAttributes={},this.cid=r.uniqueId("c"),this.changed={},this._silent={},this._pending={},this.set(e,{silent:!0}),this.changed={},this._silent={},this._pending={},this._previousAttributes=r.clone(this.attributes),this.initialize.apply(this,arguments)};r.extend(h.prototype,a,{changed:null,_silent:null,_pending:null,idAttribute:"id",initialize:function(){},toJSON:function(){return r.clone(this.attributes)},get:function(e){return this.attributes[e]},escape:function(e){var t;if(t=this._escapedAttributes[e])return t;var o=this.get(e);return this._escapedAttributes[e]=r.escape(null==o?"":""+o)},has:function(e){return null!=this.get(e)},set:function(e,t,o){var l,i,n;if(r.isObject(e)||null==e?(l=e,o=t):(l={},l[e]=t),o||(o={}),!l)return this;if(l instanceof h&&(l=l.attributes),o.unset)for(i in l)l[i]=void 0;if(!this._validate(l,o))return!1;this.idAttribute in l&&(this.id=l[this.idAttribute]);var s=o.changes={},a=this.attributes,u=this._escapedAttributes,d=this._previousAttributes||{};for(i in l)n=l[i],(!r.isEqual(a[i],n)||o.unset&&r.has(a,i))&&(delete u[i],(o.silent?this._silent:s)[i]=!0),o.unset?delete a[i]:a[i]=n,r.isEqual(d[i],n)&&r.has(a,i)==r.has(d,i)?(delete this.changed[i],delete this._pending[i]):(this.changed[i]=n,o.silent||(this._pending[i]=!0));return o.silent||this.change(o),this},unset:function(e,t){return(t||(t={})).unset=!0,this.set(e,null,t)},clear:function(e){return(e||(e={})).unset=!0,this.set(r.clone(this.attributes),e)},fetch:function(t){t=t?r.clone(t):{};var o=this,l=t.success;return t.success=function(e,i,r){return o.set(o.parse(e,r),t)?void(l&&l(o,e)):!1},t.error=e.wrapError(t.error,o,t),(this.sync||e.sync).call(this,"read",this,t)},save:function(t,o,l){var i,n;if(r.isObject(t)||null==t?(i=t,l=o):(i={},i[t]=o),l=l?r.clone(l):{},l.wait){if(!this._validate(i,l))return!1;n=r.clone(this.attributes)}var s=r.extend({},l,{silent:!0});if(i&&!this.set(i,l.wait?s:l))return!1;var a=this,h=l.success;l.success=function(e,t,o){var n=a.parse(e,o);return l.wait&&(delete l.wait,n=r.extend(i||{},n)),a.set(n,l)?void(h?h(a,e):a.trigger("sync",a,e,l)):!1},l.error=e.wrapError(l.error,a,l);var u=this.isNew()?"create":"update",d=(this.sync||e.sync).call(this,u,this,l);return l.wait&&this.set(n,s),d},destroy:function(t){t=t?r.clone(t):{};var o=this,l=t.success,i=function(){o.trigger("destroy",o,o.collection,t)};if(this.isNew())return i(),!1;t.success=function(e){t.wait&&i(),l?l(o,e):o.trigger("sync",o,e,t)},t.error=e.wrapError(t.error,o,t);var n=(this.sync||e.sync).call(this,"delete",this,t);return t.wait||i(),n},url:function(){var e=k(this,"urlRoot")||k(this.collection,"url")||E();return this.isNew()?e:e+("/"==e.charAt(e.length-1)?"":"/")+encodeURIComponent(this.id)},parse:function(e){return e},clone:function(){return new this.constructor(this.attributes)},isNew:function(){return null==this.id},change:function(e){e||(e={});var t=this._changing;this._changing=!0;for(var o in this._silent)this._pending[o]=!0;var l=r.extend({},e.changes,this._silent);this._silent={};for(var o in l)this.trigger("change:"+o,this,this.get(o),e);if(t)return this;for(;!r.isEmpty(this._pending);){this._pending={},this.trigger("change",this,e);for(var o in this.changed)this._pending[o]||this._silent[o]||delete this.changed[o];this._previousAttributes=r.clone(this.attributes)}return this._changing=!1,this},hasChanged:function(e){return arguments.length?r.has(this.changed,e):!r.isEmpty(this.changed)},changedAttributes:function(e){if(!e)return this.hasChanged()?r.clone(this.changed):!1;var t,o=!1,l=this._previousAttributes;for(var i in e)r.isEqual(l[i],t=e[i])||((o||(o={}))[i]=t);return o},previous:function(e){return arguments.length&&this._previousAttributes?this._previousAttributes[e]:null},previousAttributes:function(){return r.clone(this._previousAttributes)},isValid:function(){return!this.validate(this.attributes)},_validate:function(e,t){if(t.silent||!this.validate)return!0;e=r.extend({},this.attributes,e);var o=this.validate(e,t);return o?(t&&t.error?t.error(this,o,t):this.trigger("error",this,o,t),!1):!0}});var u=e.Collection=function(e,t){t||(t={}),t.model&&(this.model=t.model),t.comparator&&(this.comparator=t.comparator),this._reset(),this.initialize.apply(this,arguments),e&&this.reset(e,{silent:!0,parse:t.parse})};r.extend(u.prototype,a,{model:h,initialize:function(){},toJSON:function(e){return this.map(function(t){return t.toJSON(e)})},add:function(e,t){var o,l,n,s,a,h,u={},d={},c=[];for(t||(t={}),e=r.isArray(e)?e.slice():[e],o=0,n=e.length;n>o;o++){if(!(s=e[o]=this._prepareModel(e[o],t)))throw new Error("Can't add an invalid model to a collection");a=s.cid,h=s.id,u[a]||this._byCid[a]||null!=h&&(d[h]||this._byId[h])?c.push(o):u[a]=d[h]=s}for(o=c.length;o--;)e.splice(c[o],1);for(o=0,n=e.length;n>o;o++)(s=e[o]).on("all",this._onModelEvent,this),this._byCid[s.cid]=s,null!=s.id&&(this._byId[s.id]=s);if(this.length+=n,l=null!=t.at?t.at:this.models.length,i.apply(this.models,[l,0].concat(e)),this.comparator&&this.sort({silent:!0}),t.silent)return this;for(o=0,n=this.models.length;n>o;o++)u[(s=this.models[o]).cid]&&(t.index=o,s.trigger("add",s,this,t));return this},remove:function(e,t){var o,l,i,n;for(t||(t={}),e=r.isArray(e)?e.slice():[e],o=0,l=e.length;l>o;o++)n=this.getByCid(e[o])||this.get(e[o]),n&&(delete this._byId[n.id],delete this._byCid[n.cid],i=this.indexOf(n),this.models.splice(i,1),this.length--,t.silent||(t.index=i,n.trigger("remove",n,this,t)),this._removeReference(n));return this},push:function(e,t){return e=this._prepareModel(e,t),this.add(e,t),e},pop:function(e){var t=this.at(this.length-1);return this.remove(t,e),t},unshift:function(e,t){return e=this._prepareModel(e,t),this.add(e,r.extend({at:0},t)),e},shift:function(e){var t=this.at(0);return this.remove(t,e),t},get:function(e){return null==e?void 0:this._byId[null!=e.id?e.id:e]},getByCid:function(e){return e&&this._byCid[e.cid||e]},at:function(e){return this.models[e]},where:function(e){return r.isEmpty(e)?[]:this.filter(function(t){for(var o in e)if(e[o]!==t.get(o))return!1;return!0})},sort:function(e){if(e||(e={}),!this.comparator)throw new Error("Cannot sort a set without a comparator");var t=r.bind(this.comparator,this);return 1==this.comparator.length?this.models=this.sortBy(t):this.models.sort(t),e.silent||this.trigger("reset",this,e),this},pluck:function(e){return r.map(this.models,function(t){return t.get(e)})},reset:function(e,t){e||(e=[]),t||(t={});for(var o=0,l=this.models.length;l>o;o++)this._removeReference(this.models[o]);return this._reset(),this.add(e,r.extend({silent:!0},t)),t.silent||this.trigger("reset",this,t),this},fetch:function(t){t=t?r.clone(t):{},void 0===t.parse&&(t.parse=!0);var o=this,l=t.success;return t.success=function(e,i,r){o[t.add?"add":"reset"](o.parse(e,r),t),l&&l(o,e)},t.error=e.wrapError(t.error,o,t),(this.sync||e.sync).call(this,"read",this,t)},create:function(e,t){var o=this;if(t=t?r.clone(t):{},e=this._prepareModel(e,t),!e)return!1;t.wait||o.add(e,t);var l=t.success;return t.success=function(i,r){t.wait&&o.add(i,t),l?l(i,r):i.trigger("sync",e,r,t)},e.save(null,t),e},parse:function(e){return e},chain:function(){return r(this.models).chain()},_reset:function(){this.length=0,this.models=[],this._byId={},this._byCid={}},_prepareModel:function(e,t){if(t||(t={}),e instanceof h)e.collection||(e.collection=this);else{var o=e;t.collection=this,e=new this.model(o,t),e._validate(e.attributes,t)||(e=!1)}return e},_removeReference:function(e){this==e.collection&&delete e.collection,e.off("all",this._onModelEvent,this)},_onModelEvent:function(e,t,o,l){("add"!=e&&"remove"!=e||o==this)&&("destroy"==e&&this.remove(t,l),t&&e==="change:"+t.idAttribute&&(delete this._byId[t.previous(t.idAttribute)],this._byId[t.id]=t),this.trigger.apply(this,arguments))}});var d=["forEach","each","map","reduce","reduceRight","find","detect","filter","select","reject","every","all","some","any","include","contains","invoke","max","min","sortBy","sortedIndex","toArray","size","first","initial","rest","last","without","indexOf","shuffle","lastIndexOf","isEmpty","groupBy"];r.each(d,function(e){u.prototype[e]=function(){return r[e].apply(r,[this.models].concat(r.toArray(arguments)))}});var c=e.Router=function(e){e||(e={}),e.routes&&(this.routes=e.routes),this._bindRoutes(),this.initialize.apply(this,arguments)},p=/:\w+/g,f=/\*\w+/g,m=/[-[\]{}()+?.,\\^$|#\s]/g;r.extend(c.prototype,a,{initialize:function(){},route:function(t,o,l){return e.history||(e.history=new g),r.isRegExp(t)||(t=this._routeToRegExp(t)),l||(l=this[o]),e.history.route(t,r.bind(function(i){var r=this._extractParameters(t,i);l&&l.apply(this,r),this.trigger.apply(this,["route:"+o].concat(r)),e.history.trigger("route",this,o,r)},this)),this},navigate:function(t,o){e.history.navigate(t,o)},_bindRoutes:function(){if(this.routes){var e=[];for(var t in this.routes)e.unshift([t,this.routes[t]]);for(var o=0,l=e.length;l>o;o++)this.route(e[o][0],e[o][1],this[e[o][1]])}},_routeToRegExp:function(e){return e=e.replace(m,"\\$&").replace(p,"([^/]+)").replace(f,"(.*?)"),new RegExp("^"+e+"$")},_extractParameters:function(e,t){return e.exec(t).slice(1)}});var g=e.History=function(){this.handlers=[],r.bindAll(this,"checkUrl")},b=/^[#\/]/,y=/msie [\w.]+/;g.started=!1,r.extend(g.prototype,a,{interval:50,getHash:function(e){var t=e?e.location:window.location,o=t.href.match(/#(.*)$/);return o?o[1]:""},getFragment:function(e,t){if(null==e)if(this._hasPushState||t){e=window.location.pathname;var o=window.location.search;o&&(e+=o)}else e=this.getHash();return e.indexOf(this.options.root)||(e=e.substr(this.options.root.length)),e.replace(b,"")},start:function(e){if(g.started)throw new Error("Backbone.history has already been started");g.started=!0,this.options=r.extend({},{root:"/"},this.options,e),this._wantsHashChange=this.options.hashChange!==!1,this._wantsPushState=!!this.options.pushState,this._hasPushState=!!(this.options.pushState&&window.history&&window.history.pushState);var t=this.getFragment(),o=document.documentMode,l=y.exec(navigator.userAgent.toLowerCase())&&(!o||7>=o);l&&(this.iframe=n('<iframe src="javascript:0" tabindex="-1" />').hide().appendTo("body")[0].contentWindow,this.navigate(t)),this._hasPushState?n(window).bind("popstate",this.checkUrl):this._wantsHashChange&&"onhashchange"in window&&!l?n(window).bind("hashchange",this.checkUrl):this._wantsHashChange&&(this._checkUrlInterval=setInterval(this.checkUrl,this.interval)),this.fragment=t;var i=window.location,s=i.pathname==this.options.root;return this._wantsHashChange&&this._wantsPushState&&!this._hasPushState&&!s?(this.fragment=this.getFragment(null,!0),window.location.replace(this.options.root+"#"+this.fragment),!0):(this._wantsPushState&&this._hasPushState&&s&&i.hash&&(this.fragment=this.getHash().replace(b,""),window.history.replaceState({},document.title,i.protocol+"//"+i.host+this.options.root+this.fragment)),this.options.silent?void 0:this.loadUrl())},stop:function(){n(window).unbind("popstate",this.checkUrl).unbind("hashchange",this.checkUrl),clearInterval(this._checkUrlInterval),g.started=!1},route:function(e,t){this.handlers.unshift({route:e,callback:t})},checkUrl:function(){var e=this.getFragment();return e==this.fragment&&this.iframe&&(e=this.getFragment(this.getHash(this.iframe))),e==this.fragment?!1:(this.iframe&&this.navigate(e),void(this.loadUrl()||this.loadUrl(this.getHash())))},loadUrl:function(e){var t=this.fragment=this.getFragment(e),o=r.any(this.handlers,function(e){return e.route.test(t)?(e.callback(t),!0):void 0});return o},navigate:function(e,t){if(!g.started)return!1;t&&t!==!0||(t={trigger:t});var o=(e||"").replace(b,"");this.fragment!=o&&(this._hasPushState?(0!=o.indexOf(this.options.root)&&(o=this.options.root+o),this.fragment=o,window.history[t.replace?"replaceState":"pushState"]({},document.title,o)):this._wantsHashChange?(this.fragment=o,this._updateHash(window.location,o,t.replace),this.iframe&&o!=this.getFragment(this.getHash(this.iframe))&&(t.replace||this.iframe.document.open().close(),this._updateHash(this.iframe.location,o,t.replace))):window.location.assign(this.options.root+e),t.trigger&&this.loadUrl(e))},_updateHash:function(e,t,o){o?e.replace(e.toString().replace(/(javascript:|#).*$/,"")+"#"+t):e.hash=t}});var A=e.View=function(e){this.cid=r.uniqueId("view"),this._configure(e||{}),this._ensureElement(),this.initialize.apply(this,arguments),this.delegateEvents()},C=/^(\S+)\s*(.*)$/,v=["model","collection","el","id","attributes","className","tagName"];r.extend(A.prototype,a,{tagName:"div",$:function(e){return this.$el.find(e)},initialize:function(){},render:function(){return this},remove:function(){return this.$el.remove(),this},make:function(e,t,o){var l=document.createElement(e);return t&&n(l).attr(t),o&&n(l).html(o),l},setElement:function(e,t){return this.$el&&this.undelegateEvents(),this.$el=e instanceof n?e:n(e),this.el=this.$el[0],t!==!1&&this.delegateEvents(),this},delegateEvents:function(e){if(e||(e=k(this,"events"))){this.undelegateEvents();for(var t in e){var o=e[t];if(r.isFunction(o)||(o=this[e[t]]),!o)throw new Error('Method "'+e[t]+'" does not exist');var l=t.match(C),i=l[1],n=l[2];o=r.bind(o,this),i+=".delegateEvents"+this.cid,""===n?this.$el.bind(i,o):this.$el.delegate(n,i,o)}}},undelegateEvents:function(){this.$el.unbind(".delegateEvents"+this.cid)},_configure:function(e){this.options&&(e=r.extend({},this.options,e));for(var t=0,o=v.length;o>t;t++){var l=v[t];e[l]&&(this[l]=e[l])}this.options=e},_ensureElement:function(){if(this.el)this.setElement(this.el,!1);else{var e=k(this,"attributes")||{};this.id&&(e.id=this.id),this.className&&(e["class"]=this.className),this.setElement(this.make(this.tagName,e),!1)}}});var G=function(e,t){var o=T(this,e,t);return o.extend=this.extend,o};h.extend=u.extend=c.extend=A.extend=G;var _={create:"POST",update:"PUT","delete":"DELETE",read:"GET"};e.sync=function(t,o,l){var i=_[t];l||(l={});var s={type:i,dataType:"json"};return l.url||(s.url=k(o,"url")||E()),l.data||!o||"create"!=t&&"update"!=t||(s.contentType="application/json",s.data=JSON.stringify(o.toJSON())),e.emulateJSON&&(s.contentType="application/x-www-form-urlencoded",s.data=s.data?{model:s.data}:{}),e.emulateHTTP&&("PUT"===i||"DELETE"===i)&&(e.emulateJSON&&(s.data._method=i),s.type="POST",s.beforeSend=function(e){e.setRequestHeader("X-HTTP-Method-Override",i)}),"GET"===s.type||e.emulateJSON||(s.processData=!1),n.ajax(r.extend(s,l))},e.wrapError=function(e,t,o){return function(l,i){i=l===t?i:l,e?e(t,i,o):t.trigger("error",t,i,o)}};var w=function(){},T=function(e,t,o){var l;return l=t&&t.hasOwnProperty("constructor")?t.constructor:function(){e.apply(this,arguments)},r.extend(l,e),w.prototype=e.prototype,l.prototype=new w,t&&r.extend(l.prototype,t),o&&r.extend(l,o),l.prototype.constructor=l,l.__super__=e.prototype,l},k=function(e,t){return e&&e[t]?r.isFunction(e[t])?e[t]():e[t]:null},E=function(){throw new Error('A "url" property or function must be specified')}}).call(this);