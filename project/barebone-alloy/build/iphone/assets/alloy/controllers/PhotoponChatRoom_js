function __processArg(e,t){var o=null;return e&&(o=e[t]||null,delete e[t]),o}function Controller(){require("alloy/controllers/BaseController").apply(this,Array.prototype.slice.call(arguments)),this.__controllerPath="PhotoponChatRoom",this.args=arguments[0]||{},arguments[0]&&(__processArg(arguments[0],"__parentSymbol"),__processArg(arguments[0],"$model"),__processArg(arguments[0],"__itemTemplate"));var e=this,t={};e.__views.winChatRoom=Ti.UI.createWindow({id:"winChatRoom",title:"Message"}),e.__views.winChatRoom&&e.addTopLevelView(e.__views.winChatRoom),t.destroy=function(){},_.extend(e,e.__views);var o=arguments[0]||{},l=PUI.DecorateWindow(e.winChatRoom);l.title=o.user.username;var i=PUI.Awesomize(l),r=PUI.CreateTable(l);r.top=40,r.height=Titanium.Platform.displayCaps.platformHeight-80;var n=function(e,t){var o=PUI.CreateRow(r),l=PUI.CreateLabel(o,e.username+": "+t);l.width=Titanium.Platform.displayCaps.platformWidth-10,l.left=5,e.id==UTL.userInfo().uid?(l.textAlign=Titanium.UI.TEXT_ALIGNMENT_LEFT,l.color=PUI.Colors.lightBlue):(l.textAlign=Titanium.UI.TEXT_ALIGNMENT_RIGHT,l.color=PUI.Colors.darkestPurple),console.log("AddMessage",e.username,t),r.setData(r.data)},a=PUI.CreateInput(l,"Enter message");a.bottom=0,a.left=5,a.right=null,a.width=Titanium.Platform.displayCaps.platformWidth-50;var s=PUI.CreateButton(l,"",function(){var e=a.value;""!=e.trim()&&(a.value="",Cloud.Chats.create({to_ids:o.user.id,message:e},function(e){if(!e.success)return void alert("Failed to send message");for(var t=0;t<e.chats.length;t++){var o=e.chats[t];n(o.from,o.message)}}))});i.add(s.label,"fa-send"),s.height=35,s.width=35,s.left=null,s.right=5,s.bottom=5;var d=null,u=0,c=function(){console.log("Update messages from "+u),Cloud.Chats.query({participate_ids:[o.user.id,UTL.userInfo().uid].join(","),where:{updated_at:{$gt:u}}},function(e){if(!e.success)return void console.log("Failed to get messages");for(var t=e.chats.length-1;t>=0;t--){var o=e.chats[t];u=o.updated_at,n(o.from,o.message)}})};l.addEventListener("open",function(){d&&(console.log("Cancelling update timer"),clearInterval(d),d=null),u=0,console.log("Creating update timer"),d=setInterval(c,3e3),c()}),l.addEventListener("close",function(){d&&(console.log("Cancelling update timer"),clearInterval(d),d=null)}),_.extend(e,t)}var Alloy=require("alloy"),Backbone=Alloy.Backbone,_=Alloy._;module.exports=Controller;