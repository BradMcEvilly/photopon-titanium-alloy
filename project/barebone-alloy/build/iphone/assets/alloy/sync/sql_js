function S4(){return(65536*(1+Math.random())|0).toString(16).substring(1)}function guid(){return S4()+S4()+"-"+S4()+"-"+S4()+"-"+S4()+"-"+S4()+S4()+S4()}function Migrator(e,l){this.db=l,this.dbname=e.adapter.db_name,this.table=e.adapter.collection_name,this.idAttribute=e.adapter.idAttribute,this.column=function(e){var l=e.split(/\s+/),o=l[0];switch(o.toLowerCase()){case"string":case"varchar":case"date":case"datetime":Ti.API.warn('"'+o+'" is not a valid sqlite field, using TEXT instead');case"text":o="TEXT";break;case"int":case"tinyint":case"smallint":case"bigint":case"boolean":Ti.API.warn('"'+o+'" is not a valid sqlite field, using INTEGER instead');case"integer":o="INTEGER";break;case"double":case"float":case"decimal":case"number":Ti.API.warn('"'+e+'" is not a valid sqlite field, using REAL instead');case"real":o="REAL";break;case"blob":o="BLOB";break;case"null":o="NULL";break;default:o="TEXT"}return l[0]=o,l.join(" ")},this.createTable=function(e){var l=[],o=!1;for(var t in e.columns)t===this.idAttribute&&(o=!0),l.push(t+" "+this.column(e.columns[t]));o||this.idAttribute!==ALLOY_ID_DEFAULT||l.push(ALLOY_ID_DEFAULT+" TEXT UNIQUE");var i="CREATE TABLE IF NOT EXISTS "+this.table+" ( "+l.join(",")+")";this.db.execute(i)},this.dropTable=function(){this.db.execute("DROP TABLE IF EXISTS "+this.table)},this.insertRow=function(e){var l=[],o=[],t=[],i=!1;for(var r in e)r===this.idAttribute&&(i=!0),l.push(r),o.push(e[r]),t.push("?");i||this.idAttribute!==ALLOY_ID_DEFAULT||(l.push(this.idAttribute),o.push(guid()),t.push("?")),this.db.execute("INSERT INTO "+this.table+" ("+l.join(",")+") VALUES ("+t.join(",")+");",o)},this.deleteRow=function(e){var l="DELETE FROM "+this.table,o=_.keys(e),t=o.length,i=[],r=[];t&&(l+=" WHERE ");for(var a=0;t>a;a++)i.push(o[a]+" = ?"),r.push(e[o[a]]);l+=i.join(" AND "),this.db.execute(l,r)}}function Sync(e,l,o){var t,i,r=l.config.adapter.collection_name,a=l.config.columns,n=l.config.adapter.db_name||ALLOY_DB_DEFAULT,s=null;switch(e){case"create":case"update":s=function(){var e={};l.id||(l.id=l.idAttribute===ALLOY_ID_DEFAULT?guid():null,e[l.idAttribute]=l.id,"0.9.2"===backbone.VERSION?l.set(e,{silent:!0}):l.set(e));var o=[],s=[],d=[];for(var y in a)o.push(y),s.push(l.get(y)),d.push("?");return i="REPLACE INTO "+r+" ("+o.join(",")+") VALUES ("+d.join(",")+");",t=Ti.Database.open(n),t.execute(i,s),null===l.id&&(l.id=t.lastInsertRowId,e[l.idAttribute]=l.id,"0.9.2"===backbone.VERSION?l.set(e,{silent:!0}):l.set(e)),t.close(),l.toJSON()}();break;case"read":o.query&&o.id&&Ti.API.warn('Both "query" and "id" options were specified for model.fetch(). "id" will be ignored.'),i="SELECT * FROM "+r,o.query?i=o.query:o.id&&(i+=" WHERE "+(l.idAttribute?l.idAttribute:ALLOY_ID_DEFAULT)+" = "+(_.isString(o.id)?'"'+o.id+'"':o.id)),t=Ti.Database.open(n);var d;d=_.isString(i)?t.execute(i):t.execute(i.statement,i.params);for(var y=[],b=[],u=_.isFunction(d.fieldCount)?d.fieldCount():d.fieldCount,h=d.field,c=0;u>c;c++)b.push(d.fieldName(c));for(;d.isValidRow();){var g={};for(c=0;u>c;c++)g[b[c]]=h(c);y.push(g),d.next()}d.close(),t.close();var T=y.length;"0.9.2"===backbone.VERSION&&(l.length=T),s=1===T?y[0]:y;break;case"delete":i="DELETE FROM "+r+" WHERE "+l.idAttribute+"=?",t=Ti.Database.open(n),t.execute(i,l.id),t.close(),s=l.toJSON()}s?(_.isFunction(o.success)&&o.success(s),"read"!==e||o.silent||l.trigger("fetch",{fromAdapter:!0})):_.isFunction(o.error)&&o.error(s)}function GetMigrationFor(e,l){var o=null,t=Ti.Database.open(e);t.execute("CREATE TABLE IF NOT EXISTS migrations (latest TEXT, model TEXT);");var i=t.execute("SELECT latest FROM migrations where model = ?;",l);return i.isValidRow()&&(o=i.field(0)+""),i.close(),t.close(),o}function Migrate(e){var l=e.migrations||[],o={};l.length&&l[l.length-1](o);var t=e.prototype.config;t.adapter.db_name=t.adapter.db_name||ALLOY_DB_DEFAULT;var i=new Migrator(t),r="undefined"==typeof t.adapter.migration||null===t.adapter.migration?o.id:t.adapter.migration;if("undefined"==typeof r||null===r){var a=Ti.Database.open(t.adapter.db_name);return i.db=a,i.createTable(t),void a.close()}r+="";var n,s=GetMigrationFor(t.adapter.db_name,t.adapter.collection_name);if(s!==r){if(s&&s>r?(n=0,l.reverse()):n=1,db=Ti.Database.open(t.adapter.db_name),i.db=db,db.execute("BEGIN;"),l.length)for(var d=0;d<l.length;d++){var y=l[d],b={};if(y(b),n){if(b.id>r)break;if(b.id<=s)continue}else{if(b.id<=r)break;if(b.id>s)continue}var u=n?"up":"down";_.isFunction(b[u])&&b[u](i)}else i.createTable(t);db.execute("DELETE FROM migrations where model = ?",t.adapter.collection_name),db.execute("INSERT INTO migrations VALUES (?,?)",r,t.adapter.collection_name),db.execute("COMMIT;"),db.close(),i.db=null}}function installDatabase(e){var l=e.adapter.db_file,o=e.adapter.collection_name,t=/(^|.*\/)([^\/]+)\.[^\/]+$/,i=l.match(t);if(null===i)throw'Invalid sql database filename "'+l+'"';e.adapter.db_name=e.adapter.db_name||i[2];var r=e.adapter.db_name;Ti.API.debug('Installing sql database "'+l+'" with name "'+r+'"');var a=Ti.Database.install(l,r);!1===e.adapter.remoteBackup&&(Ti.API.debug('iCloud "do not backup" flag set for database "'+l+'"'),a.file.setRemoteBackup(!1));var n,s,d=a.execute('pragma table_info("'+o+'");'),y={};if(d){for(;d.isValidRow();)n=d.fieldByName("name"),s=d.fieldByName("type"),y[n]=s,n!==ALLOY_ID_DEFAULT||e.adapter.idAttribute||(e.adapter.idAttribute=ALLOY_ID_DEFAULT),d.next();d.close()}else{e.adapter.idAttribute?e.adapter.idAttribute:ALLOY_ID_DEFAULT;for(var b in e.columns)n=b,s=e.columns[b],n!==ALLOY_ID_DEFAULT||e.adapter.idAttribute?b===e.adapter.idAttribute&&(s+=" UNIQUE"):e.adapter.idAttribute=ALLOY_ID_DEFAULT,y[n]=s}if(e.columns=y,e.adapter.idAttribute){if(!_.contains(_.keys(e.columns),e.adapter.idAttribute))throw'config.adapter.idAttribute "'+e.adapter.idAttribute+'" not found in list of columns for table "'+o+'"\ncolumns: ['+_.keys(e.columns).join(",")+"]"}else{Ti.API.info('No config.adapter.idAttribute specified for table "'+o+'"'),Ti.API.info('Adding "'+ALLOY_ID_DEFAULT+'" to uniquely identify rows');var u=[],h=[];_.each(e.columns,function(e,l){h.push(l),u.push(l+" "+e)});var c=h.join(",");a.execute("ALTER TABLE "+o+" RENAME TO "+o+"_temp;"),a.execute("CREATE TABLE "+o+"("+u.join(",")+","+ALLOY_ID_DEFAULT+" TEXT UNIQUE);"),a.execute("INSERT INTO "+o+"("+c+","+ALLOY_ID_DEFAULT+") SELECT "+c+",CAST(_ROWID_ AS TEXT) FROM "+o+"_temp;"),a.execute("DROP TABLE "+o+"_temp;"),e.columns[ALLOY_ID_DEFAULT]="TEXT UNIQUE",e.adapter.idAttribute=ALLOY_ID_DEFAULT}a.close()}var _=require("alloy/underscore")._,backbone=require("alloy/backbone"),ALLOY_DB_DEFAULT="_alloy_",ALLOY_ID_DEFAULT="alloy_id",cache={config:{},Model:{}};module.exports.beforeModelCreate=function(e,l){if(cache.config[l])return cache.config[l];if("mobileweb"===Ti.Platform.osname||"undefined"==typeof Ti.Database)throw"No support for Titanium.Database in MobileWeb environment.";return e.adapter.db_file&&installDatabase(e),e.adapter.idAttribute||(Ti.API.info('No config.adapter.idAttribute specified for table "'+e.adapter.collection_name+'"'),Ti.API.info('Adding "'+ALLOY_ID_DEFAULT+'" to uniquely identify rows'),e.columns[ALLOY_ID_DEFAULT]="TEXT UNIQUE",e.adapter.idAttribute=ALLOY_ID_DEFAULT),cache.config[l]=e,e},module.exports.afterModelCreate=function(e,l){return cache.Model[l]?cache.Model[l]:(e=e||{},e.prototype.idAttribute=e.prototype.config.adapter.idAttribute,Migrate(e),cache.Model[l]=e,e)},module.exports.sync=Sync;